<script>
    var options = {};
    var currentRequest = null;

    function updateOptions(lang){
        try {
            options = JSON.parse(localStorage.options);
        }catch(e){
        }
        var defaults = {
            lang: lang,
            prefix: true
        };
        for(var key in defaults){
            if(options[key] == undefined){
                options[key] = defaults[key];
            }
        }
        if(options.prefix){
            var req = new XMLHttpRequest();
            req.open("GET", "http://meta.wikipedia.org/wiki/List_of_Wikipedias", true);
            req.onload = function(){
                if(this.status == 200){
                    try{
                        //                        console.log(this.responseText);
                        var s = '<td class="plainlinksneverexpand"><a href="http://pl.wikipedia.org/wiki/J%C4%99zyk_polski" class="external text" rel="nofollow">Polski</a></td>' +
                            '<td><a href="http://pl.wikipedia.org/wiki/" class="extiw" title="pl:">pl</a></td>';
                        console.log(s.match(/<td class="plainlinksneverexpand"><a (.+)?>(.+)?<\/a><\/td>\s*<td><a (.+)?>(.+)?<\/a><\/td>/i));
                        console.log(this.responseText.match(/<td class="plainlinksneverexpand"><a (.+)?>(.+)?<\/a><\/td>\s*<td><a (.+)?>(.+)?<\/a><\/td>/i));

                    }catch(e){
                        this.onerror();
                    }
                }else{
                    this.onerror();
                }
            };
            req.onerror = function(){
            };
            req.send();
        }
    }
	
    chrome.i18n.getAcceptLanguages(function(languages) {
        updateOptions(languages[0].substr(0, 2));
    });

    chrome.omnibox.onInputChanged.addListener(function(text, suggest) {
        if (currentRequest != null) {
            currentRequest.onreadystatechange = null;
            currentRequest.abort();
            currentRequest = null;
        }        

        updateDefaultSuggestion(text);
        
        if(text.length > 0){
            currentRequest = suggests(options.lang, text, function(data) {
                var results = [];

                for(var i = 0; i < data[1].length; i++){
                    results.push({
                        content: data[1][i],
                        description: data[1][i]
                    });
                }

                suggest(results);
            });
        }else {
         
        }
    }
);

    function resetDefaultSuggestion() {      
        chrome.omnibox.setDefaultSuggestion({
            description: ' '
        });
    }

    resetDefaultSuggestion();
    var searchLabel = chrome.i18n.getMessage('search_label');
    function updateDefaultSuggestion(text) {      
        chrome.omnibox.setDefaultSuggestion({
            description: searchLabel + ': %s'
        });
       
    }

    chrome.omnibox.onInputStarted.addListener(function() {
        updateDefaultSuggestion('');
    });

    chrome.omnibox.onInputCancelled.addListener(function() {
        resetDefaultSuggestion();
    });
    
   
    function suggests(lang, query, callback) {
        var req = new XMLHttpRequest();
      
        req.open("GET", "http://" + lang + ".wikipedia.org/w/api.php?action=opensearch&namespace=0&suggest=&search=" + query, true);
        req.onload = function(){
            if(this.status == 200){
                try{                  
                    callback(JSON.parse(this.responseText));
                }catch(e){
                    this.onerror();
                }
            }else{
                this.onerror();
            }
        };
        req.onerror = function(){

        };
        req.send();
    }

    function navigate(url) {
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.update(tab.id, {url: url});
        });
    }

    chrome.omnibox.onInputEntered.addListener(function(text) {       
        navigate("http://" + options.lang + ".wikipedia.org/w/index.php?search=" + text);
    });

    
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7218577-47']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<iframe id="temp"></iframe>